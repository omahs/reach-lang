[{"bookPath":"guide","title":"Example: Staking and Unstaking Tokens","titleId":"guide-staking","hasOtp":true,"hasPageHeader":true},"<h1 id=\"guide-staking\" class=\"refHeader\">Example: Staking and Unstaking Tokens<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#guide-staking\"><span class=\"icon icon-link\"></span></a></h1>\n<p>\n  <i id=\"p_0\" class=\"pid\"></i>Reach makes DApp development safer, faster, and more secure.\n  This guide offers a real example of the advantages of using Reach.<a href=\"#p_0\" class=\"pid\">0</a>\n</p>\n<p>\n  <i id=\"p_1\" class=\"pid\"></i>Here's an example provided by Austin Wilshire at <a href=\"https://twitter.com/xbacked\" target=\"_blank\">xBacked</a>.\n  Follow Austin on Twitter <a href=\"https://twitter.com/awoldes\" target=\"_blank\">@awoldes</a>.<a href=\"#p_1\" class=\"pid\">1</a>\n</p>\n<hr>\n<p>\n  <i id=\"p_2\" class=\"pid\"></i>Imagine you want to stake a token and at a later date unstake it with all the rewards.\n  Let's look at a snippet from the perspective of a Deployer.<a href=\"#p_2\" class=\"pid\">2</a>\n</p>\n<p><i id=\"p_3\" class=\"pid\"></i>As the deployer, you want to set the reward rate, <span class=\"snip\"><a href=\"/rsh/compute/#rsh_Token\" title=\"rsh: Token\"><span style=\"color: var(--shiki-color-text)\">Token</span></a></span> being staked, the rewarded <span class=\"snip\"><a href=\"/rsh/compute/#rsh_Token\" title=\"rsh: Token\"><span style=\"color: var(--shiki-color-text)\">Token</span></a></span>, and the initial supply of the reward token.<a href=\"#p_3\" class=\"pid\">3</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\">&nbsp;<a class=\"far fa-copy copyBtn\" data-clipboard-text=\"// Initiate the Deployer's local state\nDeployer.only(() => {\n  // this = address doing transaction\n  const deployerAddr = this;\n  // Declassify data and store in constants\n  const stakeToken = declassify(interact.setStakeToken());\n  const rewardRate = declassify(interact.setRewardRate());\n  const rewardToken = declassify(interact.setRewardToken());\n  const initialSupply = declassify(interact.setInitialSupply());\n});\n\n// Publish this information to global state\nDeployer.publish(\n  deployerAddr,\n  stakeToken,\n  rewardRate,\n  rewardToken,\n  initialSupply,\n);\" href=\"#\" id=\"copyBtn1\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"1\"><span style=\"color: var(--shiki-token-comment)\">// Initiate the Deployer's local state</span></li><li value=\"2\"><span style=\"color: var(--shiki-token-constant)\">Deployer</span><a href=\"/rsh/step/#rsh_only\" title=\"rsh: only\"><span style=\"color: var(--shiki-token-function)\">.only</span></a><span style=\"color: var(--shiki-color-text)\">(() </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"3\"><span style=\"color: var(--shiki-color-text)\">  </span><span style=\"color: var(--shiki-token-comment)\">// this = address doing transaction</span></li><li value=\"4\"><span style=\"color: var(--shiki-color-text)\">  </span><a href=\"/rsh/compute/#rsh_const\" title=\"rsh: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">deployerAddr</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">;</span></li><li value=\"5\"><span style=\"color: var(--shiki-color-text)\">  </span><span style=\"color: var(--shiki-token-comment)\">// Declassify data and store in constants</span></li><li value=\"6\"><span style=\"color: var(--shiki-color-text)\">  </span><a href=\"/rsh/compute/#rsh_const\" title=\"rsh: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">stakeToken</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/local/#rsh_declassify\" title=\"rsh: declassify\"><span style=\"color: var(--shiki-token-function)\">declassify</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/local/#rsh_interact\" title=\"rsh: interact\"><span style=\"color: var(--shiki-token-constant)\">interact</span></a><span style=\"color: var(--shiki-token-function)\">.setStakeToken</span><span style=\"color: var(--shiki-color-text)\">());</span></li><li value=\"7\"><span style=\"color: var(--shiki-color-text)\">  </span><a href=\"/rsh/compute/#rsh_const\" title=\"rsh: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">rewardRate</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/local/#rsh_declassify\" title=\"rsh: declassify\"><span style=\"color: var(--shiki-token-function)\">declassify</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/local/#rsh_interact\" title=\"rsh: interact\"><span style=\"color: var(--shiki-token-constant)\">interact</span></a><span style=\"color: var(--shiki-token-function)\">.setRewardRate</span><span style=\"color: var(--shiki-color-text)\">());</span></li><li value=\"8\"><span style=\"color: var(--shiki-color-text)\">  </span><a href=\"/rsh/compute/#rsh_const\" title=\"rsh: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">rewardToken</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/local/#rsh_declassify\" title=\"rsh: declassify\"><span style=\"color: var(--shiki-token-function)\">declassify</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/local/#rsh_interact\" title=\"rsh: interact\"><span style=\"color: var(--shiki-token-constant)\">interact</span></a><span style=\"color: var(--shiki-token-function)\">.setRewardToken</span><span style=\"color: var(--shiki-color-text)\">());</span></li><li value=\"9\"><span style=\"color: var(--shiki-color-text)\">  </span><a href=\"/rsh/compute/#rsh_const\" title=\"rsh: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">initialSupply</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/rsh/local/#rsh_declassify\" title=\"rsh: declassify\"><span style=\"color: var(--shiki-token-function)\">declassify</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/local/#rsh_interact\" title=\"rsh: interact\"><span style=\"color: var(--shiki-token-constant)\">interact</span></a><span style=\"color: var(--shiki-token-function)\">.setInitialSupply</span><span style=\"color: var(--shiki-color-text)\">());</span></li><li value=\"10\"><span style=\"color: var(--shiki-color-text)\">});</span></li><li value=\"11\"></li><li value=\"12\"><span style=\"color: var(--shiki-token-comment)\">// Publish this information to global state</span></li><li value=\"13\"><span style=\"color: var(--shiki-token-constant)\">Deployer</span><a href=\"/rsh/step/#rsh_publish\" title=\"rsh: publish\"><span style=\"color: var(--shiki-token-function)\">.publish</span></a><span style=\"color: var(--shiki-color-text)\">(</span></li><li value=\"14\"><span style=\"color: var(--shiki-color-text)\">  deployerAddr</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"15\"><span style=\"color: var(--shiki-color-text)\">  stakeToken</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"16\"><span style=\"color: var(--shiki-color-text)\">  rewardRate</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"17\"><span style=\"color: var(--shiki-color-text)\">  rewardToken</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"18\"><span style=\"color: var(--shiki-color-text)\">  initialSupply</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"19\"><span style=\"color: var(--shiki-color-text)\">);</span></li></ol></pre>\n<p>\n  <i id=\"p_4\" class=\"pid\"></i>After this, the contract is fully configured and deployed.\n  The next step is to enable users to interact with it.<a href=\"#p_4\" class=\"pid\">4</a>\n</p>\n<h1 id=\"staking\" class=\"refHeader\">Staking<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#staking\"><span class=\"icon icon-link\"></span></a></h1>\n<p>\n  <i id=\"p_5\" class=\"pid\"></i>First, we want to enable a user to add a stake.\n  We do this by adding an API call so that when the user calls the function, they will pay <span class=\"snip\"><span style=\"color: var(--shiki-color-text)\">tokenAmt</span></span> of the <span class=\"snip\"><span style=\"color: var(--shiki-color-text)\">stakeToken</span></span> which the Deployer set.<a href=\"#p_5\" class=\"pid\">5</a>\n</p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\">&nbsp;<a class=\"far fa-copy copyBtn\" data-clipboard-text=\".api(User.stakeTokens,\n  (tokenAmt) => {\n    // Valid that the user must stake more than 1 token.\n    // They will receive the message on the frontend if they don't.\n    assume(tokenAmt >= 1, 'Must stake at least 1 token');\n  },\n  (tokenAmt) => {\n    // This means the user will:\n    // - pay 0 network tokens; and,\n    // - pay tokenAmt in stakeTokens\n    return [0, [tokenAmt, stakeToken]];\n  },\n  (tokenAmt, apiReturn) => {\n    // This require matches the assume above\n    require(tokenAmt >= 1, 'Must stake at least 1 token');\n\n    // We record in a Map that the user staked\n    userStakes[this] = {\n        stake: tokenAmt,\n        pendingRewards: 0,\n    };\n    // Return to the API caller\n    apiReturn(true);\n    // Update global state\n    return rewardSupply;\n  }\n)\" href=\"#\" id=\"copyBtn2\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"1\"><span style=\"color: var(--shiki-token-function)\">.api</span><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">User</span><span style=\"color: var(--shiki-color-text)\">.stakeTokens</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"2\"><span style=\"color: var(--shiki-color-text)\">  (tokenAmt) </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"3\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-comment)\">// Valid that the user must stake more than 1 token.</span></li><li value=\"4\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-comment)\">// They will receive the message on the frontend if they don't.</span></li><li value=\"5\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/local/#rsh_assume\" title=\"rsh: assume\"><span style=\"color: var(--shiki-token-function)\">assume</span></a><span style=\"color: var(--shiki-color-text)\">(tokenAmt </span><a href=\"/rsh/compute/#rsh_%3E=\" title=\"rsh: >=\"><span style=\"color: var(--shiki-token-keyword)\">&gt;=</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">1</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">'Must stake at least 1 token'</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"6\"><span style=\"color: var(--shiki-color-text)\">  }</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"7\"><span style=\"color: var(--shiki-color-text)\">  (tokenAmt) </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"8\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-comment)\">// This means the user will:</span></li><li value=\"9\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-comment)\">// - pay 0 network tokens; and,</span></li><li value=\"10\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-comment)\">// - pay tokenAmt in stakeTokens</span></li><li value=\"11\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\"> [</span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> [tokenAmt</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> stakeToken]];</span></li><li value=\"12\"><span style=\"color: var(--shiki-color-text)\">  }</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"13\"><span style=\"color: var(--shiki-color-text)\">  (tokenAmt</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> apiReturn) </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"14\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-comment)\">// This require matches the assume above</span></li><li value=\"15\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/consensus/#rsh_require\" title=\"rsh: require\"><span style=\"color: var(--shiki-token-function)\">require</span></a><span style=\"color: var(--shiki-color-text)\">(tokenAmt </span><a href=\"/rsh/compute/#rsh_%3E=\" title=\"rsh: >=\"><span style=\"color: var(--shiki-token-keyword)\">&gt;=</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">1</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">'Must stake at least 1 token'</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"16\"></li><li value=\"17\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-comment)\">// We record in a Map that the user staked</span></li><li value=\"18\"><span style=\"color: var(--shiki-color-text)\">    userStakes[</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">] </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"19\"><span style=\"color: var(--shiki-color-text)\">        stake</span><span style=\"color: var(--shiki-token-keyword)\">:</span><span style=\"color: var(--shiki-color-text)\"> tokenAmt</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"20\"><span style=\"color: var(--shiki-color-text)\">        pendingRewards</span><span style=\"color: var(--shiki-token-keyword)\">:</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"21\"><span style=\"color: var(--shiki-color-text)\">    };</span></li><li value=\"22\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-comment)\">// Return to the API caller</span></li><li value=\"23\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-function)\">apiReturn</span><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_true\" title=\"rsh: true\"><span style=\"color: var(--shiki-token-constant)\">true</span></a><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"24\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-comment)\">// Update global state</span></li><li value=\"25\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\"> rewardSupply;</span></li><li value=\"26\"><span style=\"color: var(--shiki-color-text)\">  }</span></li><li value=\"27\"><span style=\"color: var(--shiki-color-text)\">)</span></li></ol></pre>\n<p>\n  <i id=\"p_6\" class=\"pid\"></i>In a full implementation, we would enable users to stake multiple times and\n  combine their stakes.\n  (This version resets the stake each time, so it is dangerous and would lose\n  track of a user's funds.)<a href=\"#p_6\" class=\"pid\">6</a>\n</p>\n<h1 id=\"unstaking\" class=\"refHeader\">Unstaking<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#unstaking\"><span class=\"icon icon-link\"></span></a></h1>\n<p>\n  <i id=\"p_7\" class=\"pid\"></i>Similarly, we want the user to be able to unstake and claim their rewards.\n  We do this with an API call as well.<a href=\"#p_7\" class=\"pid\">7</a>\n</p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\">&nbsp;<a class=\"far fa-copy copyBtn\" data-clipboard-text=\".api(User.unstakeAndClaim,\n  () => {\n    // Ensure that rewards are available\n    assume(balance(rewardToken) > 0, 'No rewards left');\n  },\n  () => {\n    // Transfer nothing to the contract\n    return [0, [0, stakeToken]];\n  },\n  (apiReturn) => {\n    require(balance(rewardToken) > 0, 'No rewards left');\n    const userState = userStakes[this];\n    // Pay acrued rewards\n    transfer([[userState.pendingrewards, rewardToken]]).to(this);\n\n    // Reset the staked amount\n    userStakes[this] = {\n        stake: 0,\n        pendingRewards: 0,\n    }\n    // Return to the API caller\n    apiReturn(true)\n    // Update global state\n    return (rewardSupply - userState.pendingRewards);\n  }\n)\" href=\"#\" id=\"copyBtn3\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"1\"><span style=\"color: var(--shiki-token-function)\">.api</span><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">User</span><span style=\"color: var(--shiki-color-text)\">.unstakeAndClaim</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"2\"><span style=\"color: var(--shiki-color-text)\">  () </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"3\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-comment)\">// Ensure that rewards are available</span></li><li value=\"4\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/local/#rsh_assume\" title=\"rsh: assume\"><span style=\"color: var(--shiki-token-function)\">assume</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_balance\" title=\"rsh: balance\"><span style=\"color: var(--shiki-token-function)\">balance</span></a><span style=\"color: var(--shiki-color-text)\">(rewardToken) </span><a href=\"/rsh/compute/#rsh_%3E\" title=\"rsh: >\"><span style=\"color: var(--shiki-token-keyword)\">&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">'No rewards left'</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"5\"><span style=\"color: var(--shiki-color-text)\">  }</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"6\"><span style=\"color: var(--shiki-color-text)\">  () </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"7\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-comment)\">// Transfer nothing to the contract</span></li><li value=\"8\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\"> [</span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> [</span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> stakeToken]];</span></li><li value=\"9\"><span style=\"color: var(--shiki-color-text)\">  }</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"10\"><span style=\"color: var(--shiki-color-text)\">  (apiReturn) </span><a href=\"/rsh/compute/#rsh_=%3E\" title=\"rsh: =>\"><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"11\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/consensus/#rsh_require\" title=\"rsh: require\"><span style=\"color: var(--shiki-token-function)\">require</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_balance\" title=\"rsh: balance\"><span style=\"color: var(--shiki-token-function)\">balance</span></a><span style=\"color: var(--shiki-color-text)\">(rewardToken) </span><a href=\"/rsh/compute/#rsh_%3E\" title=\"rsh: >\"><span style=\"color: var(--shiki-token-keyword)\">&gt;</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-string-expression)\">'No rewards left'</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"12\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/compute/#rsh_const\" title=\"rsh: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">userState</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> userStakes[</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">];</span></li><li value=\"13\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-comment)\">// Pay acrued rewards</span></li><li value=\"14\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/consensus/#rsh_transfer\" title=\"rsh: transfer\"><span style=\"color: var(--shiki-token-function)\">transfer</span></a><span style=\"color: var(--shiki-color-text)\">([[</span><span style=\"color: var(--shiki-token-constant)\">userState</span><span style=\"color: var(--shiki-color-text)\">.pendingrewards</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> rewardToken]])</span><a href=\"/rsh/consensus/#rsh_transfer.to\" title=\"rsh: transfer.to\"><span style=\"color: var(--shiki-token-function)\">.to</span></a><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"15\"></li><li value=\"16\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-comment)\">// Reset the staked amount</span></li><li value=\"17\"><span style=\"color: var(--shiki-color-text)\">    userStakes[</span><a href=\"/rsh/compute/#rsh_this\" title=\"rsh: this\"><span style=\"color: var(--shiki-token-constant)\">this</span></a><span style=\"color: var(--shiki-color-text)\">] </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"18\"><span style=\"color: var(--shiki-color-text)\">        stake</span><span style=\"color: var(--shiki-token-keyword)\">:</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"19\"><span style=\"color: var(--shiki-color-text)\">        pendingRewards</span><span style=\"color: var(--shiki-token-keyword)\">:</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">0</span><span style=\"color: var(--shiki-token-punctuation)\">,</span></li><li value=\"20\"><span style=\"color: var(--shiki-color-text)\">    }</span></li><li value=\"21\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-comment)\">// Return to the API caller</span></li><li value=\"22\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-function)\">apiReturn</span><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"/rsh/compute/#rsh_true\" title=\"rsh: true\"><span style=\"color: var(--shiki-token-constant)\">true</span></a><span style=\"color: var(--shiki-color-text)\">)</span></li><li value=\"23\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-comment)\">// Update global state</span></li><li value=\"24\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"/rsh/compute/#rsh_return\" title=\"rsh: return\"><span style=\"color: var(--shiki-token-keyword)\">return</span></a><span style=\"color: var(--shiki-color-text)\"> (rewardSupply </span><a href=\"/rsh/compute/#rsh_-\" title=\"rsh: -\"><span style=\"color: var(--shiki-token-keyword)\">-</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">userState</span><span style=\"color: var(--shiki-color-text)\">.pendingRewards);</span></li><li value=\"25\"><span style=\"color: var(--shiki-color-text)\">  }</span></li><li value=\"26\"><span style=\"color: var(--shiki-color-text)\">)</span></li></ol></pre>\n<p>\n  <i id=\"p_8\" class=\"pid\"></i>In a full implementation, we would have to specify how the <code>pendingRewards</code>\n  value was computed.\n  We could make it automatic by connecting it to something like <span class=\"snip\"><a href=\"/rsh/compute/#rsh_lastConsensusTime\" title=\"rsh: lastConsensusTime\"><span style=\"color: var(--shiki-color-text)\">lastConsensusTime</span></a></span>.<a href=\"#p_8\" class=\"pid\">8</a>\n</p>\n<h1 id=\"elided-reach\" class=\"refHeader\">Elided Reach<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#elided-reach\"><span class=\"icon icon-link\"></span></a></h1>\n<p>\n  <i id=\"p_9\" class=\"pid\"></i>We haven't shown the entire Reach program.\n  We didn't show the definition of the participants, APIs, or Views.\n  We didn't show the main <span class=\"snip\"><a href=\"/rsh/consensus/#rsh_parallelReduce\" title=\"rsh: parallelReduce\"><span style=\"color: var(--shiki-color-text)\">parallelReduce</span></a></span> or its invariants.<a href=\"#p_9\" class=\"pid\">9</a>\n</p>\n<h1 id=\"connecting-from-javascript\" class=\"refHeader\">Connecting from JavaScript<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#connecting-from-javascript\"><span class=\"icon icon-link\"></span></a></h1>\n<p>\n  <i id=\"p_10\" class=\"pid\"></i>Next, we'll want to use this program in a Web application.\n  In this code, we assume that the Web application is written with React.<a href=\"#p_10\" class=\"pid\">10</a>\n</p>\n<p><i id=\"p_11\" class=\"pid\"></i>We use the Reach standard library to connect to the <a href=\"/frontend/#ref-frontends-js-ctc\">contract</a>, define the User's <a href=\"/rsh/appinit/#ref-programs-appinit-api\">API</a> calls, and the <a href=\"/rsh/appinit/#ref-programs-appinit-view\">View</a>.<a href=\"#p_11\" class=\"pid\">11</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\">&nbsp;<a class=\"far fa-copy copyBtn\" data-clipboard-text=\"// Connect the account\nconst account = await stdlib.getDefaultAccount();\n// Construct a contract handle\nconst ctcInfo = account.contract(backend, CONTRACT_INFO);\n// Defines all User api calls (stakeTokens, unstaketokens)\nconst userApi = contract.a.User;\n// Defines the View\nconst userView = contract.v.read;\" href=\"#\" id=\"copyBtn4\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"1\"><span style=\"color: var(--shiki-token-comment)\">// Connect the account</span></li><li value=\"2\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const\" title=\"js: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">account</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await\" title=\"js: await\"><span style=\"color: var(--shiki-token-keyword)\">await</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">stdlib</span><a href=\"/frontend/#js_stdlib.getDefaultAccount\" title=\"js: stdlib.getDefaultAccount\"><span style=\"color: var(--shiki-token-function)\">.getDefaultAccount</span></a><span style=\"color: var(--shiki-color-text)\">();</span></li><li value=\"3\"><span style=\"color: var(--shiki-token-comment)\">// Construct a contract handle</span></li><li value=\"4\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const\" title=\"js: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">ctcInfo</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">account</span><a href=\"/frontend/#js_contract\" title=\"js: contract\"><span style=\"color: var(--shiki-token-function)\">.contract</span></a><span style=\"color: var(--shiki-color-text)\">(backend</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">CONTRACT_INFO</span><span style=\"color: var(--shiki-color-text)\">);</span></li><li value=\"5\"><span style=\"color: var(--shiki-token-comment)\">// Defines all User api calls (stakeTokens, unstaketokens)</span></li><li value=\"6\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const\" title=\"js: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">userApi</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/frontend/#js_contract\" title=\"js: contract\"><span style=\"color: var(--shiki-token-constant)\">contract</span></a><span style=\"color: var(--shiki-color-text)\">.</span><span style=\"color: var(--shiki-token-constant)\">a</span><span style=\"color: var(--shiki-color-text)\">.User;</span></li><li value=\"7\"><span style=\"color: var(--shiki-token-comment)\">// Defines the View</span></li><li value=\"8\"><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const\" title=\"js: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">userView</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"/frontend/#js_contract\" title=\"js: contract\"><span style=\"color: var(--shiki-token-constant)\">contract</span></a><span style=\"color: var(--shiki-color-text)\">.</span><span style=\"color: var(--shiki-token-constant)\">v</span><span style=\"color: var(--shiki-color-text)\">.read;</span></li></ol></pre>\n<p><i id=\"p_12\" class=\"pid\"></i>Next, we get the user's state by reading the view:<a href=\"#p_12\" class=\"pid\">12</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\">&nbsp;<a class=\"far fa-copy copyBtn\" data-clipboard-text=\"useEffect(async() => {\n    // Get user's state from application\n    const userState = await userView.read(account.addr);\n    setUserState(userState);\n}, []);\" href=\"#\" id=\"copyBtn5\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"1\"><span style=\"color: var(--shiki-token-function)\">useEffect</span><span style=\"color: var(--shiki-color-text)\">(</span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function\" title=\"js: async\"><span style=\"color: var(--shiki-token-keyword)\">async</span></a><span style=\"color: var(--shiki-color-text)\">() </span><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span><span style=\"color: var(--shiki-color-text)\"> {</span></li><li value=\"2\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-comment)\">// Get user's state from application</span></li><li value=\"3\"><span style=\"color: var(--shiki-color-text)\">    </span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const\" title=\"js: const\"><span style=\"color: var(--shiki-token-keyword)\">const</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">userState</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await\" title=\"js: await\"><span style=\"color: var(--shiki-token-keyword)\">await</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">userView</span><span style=\"color: var(--shiki-token-function)\">.read</span><span style=\"color: var(--shiki-color-text)\">(</span><span style=\"color: var(--shiki-token-constant)\">account</span><span style=\"color: var(--shiki-color-text)\">.addr);</span></li><li value=\"4\"><span style=\"color: var(--shiki-color-text)\">    </span><span style=\"color: var(--shiki-token-function)\">setUserState</span><span style=\"color: var(--shiki-color-text)\">(userState);</span></li><li value=\"5\"><span style=\"color: var(--shiki-color-text)\">}</span><span style=\"color: var(--shiki-token-punctuation)\">,</span><span style=\"color: var(--shiki-color-text)\"> []);</span></li></ol></pre>\n<p><i id=\"p_13\" class=\"pid\"></i>Then, create an event listener that connects to the API calls:<a href=\"#p_13\" class=\"pid\">13</a></p>\n<pre class=\"snippet numbered\"><div class=\"codeHeader\">&nbsp;<a class=\"far fa-copy copyBtn\" data-clipboard-text=\"<div>\n  {/* On button clicks, these functions will trigger the call */}\n  <button onClick={async () => await userApi.stakeTokens(amt)}>\n    Stake Tokens\n  </button>\n\n  <button onClick ={async () => await userApi.unstakeTokens(amt)}>\n    Unstake Tokens + {userState.pendingRewards} rewards\n  </button>\n</div>\" href=\"#\" id=\"copyBtn6\" title=\"Copy to clipboard\"></a></div><ol class=\"snippet\"><li value=\"1\"><span style=\"color: var(--shiki-color-text)\">&lt;</span><a href=\"/frontend/#js_div\" title=\"js: div\"><span style=\"color: var(--shiki-token-string-expression)\">div</span></a><span style=\"color: var(--shiki-color-text)\">&gt;</span></li><li value=\"2\"><span style=\"color: var(--shiki-color-text)\">  {</span><span style=\"color: var(--shiki-token-comment)\">/* On button clicks, these functions will trigger the call */</span><span style=\"color: var(--shiki-color-text)\">}</span></li><li value=\"3\"><span style=\"color: var(--shiki-color-text)\">  &lt;</span><span style=\"color: var(--shiki-token-string-expression)\">button</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-function)\">onClick</span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\">{</span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function\" title=\"js: async\"><span style=\"color: var(--shiki-token-keyword)\">async</span></a><span style=\"color: var(--shiki-color-text)\"> () </span><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await\" title=\"js: await\"><span style=\"color: var(--shiki-token-keyword)\">await</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">userApi</span><span style=\"color: var(--shiki-token-function)\">.stakeTokens</span><span style=\"color: var(--shiki-color-text)\">(amt)}&gt;</span></li><li value=\"4\"><span style=\"color: var(--shiki-color-text)\">    Stake Tokens</span></li><li value=\"5\"><span style=\"color: var(--shiki-color-text)\">  &lt;/</span><span style=\"color: var(--shiki-token-string-expression)\">button</span><span style=\"color: var(--shiki-color-text)\">&gt;</span></li><li value=\"6\"></li><li value=\"7\"><span style=\"color: var(--shiki-color-text)\">  &lt;</span><span style=\"color: var(--shiki-token-string-expression)\">button</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-function)\">onClick</span><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-keyword)\">=</span><span style=\"color: var(--shiki-color-text)\">{</span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function\" title=\"js: async\"><span style=\"color: var(--shiki-token-keyword)\">async</span></a><span style=\"color: var(--shiki-color-text)\"> () </span><span style=\"color: var(--shiki-token-keyword)\">=&gt;</span><span style=\"color: var(--shiki-color-text)\"> </span><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await\" title=\"js: await\"><span style=\"color: var(--shiki-token-keyword)\">await</span></a><span style=\"color: var(--shiki-color-text)\"> </span><span style=\"color: var(--shiki-token-constant)\">userApi</span><span style=\"color: var(--shiki-token-function)\">.unstakeTokens</span><span style=\"color: var(--shiki-color-text)\">(amt)}&gt;</span></li><li value=\"8\"><span style=\"color: var(--shiki-color-text)\">    Unstake Tokens + {</span><span style=\"color: var(--shiki-token-constant)\">userState</span><span style=\"color: var(--shiki-color-text)\">.pendingRewards} rewards</span></li><li value=\"9\"><span style=\"color: var(--shiki-color-text)\">  &lt;/</span><span style=\"color: var(--shiki-token-string-expression)\">button</span><span style=\"color: var(--shiki-color-text)\">&gt;</span></li><li value=\"10\"><span style=\"color: var(--shiki-color-text)\">&lt;/</span><a href=\"/frontend/#js_div\" title=\"js: div\"><span style=\"color: var(--shiki-token-string-expression)\">div</span></a><span style=\"color: var(--shiki-color-text)\">&gt;</span></li></ol></pre>\n<h1 id=\"conclusion\" class=\"refHeader\">Conclusion<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#conclusion\"><span class=\"icon icon-link\"></span></a></h1>\n<p>\n  <i id=\"p_14\" class=\"pid\"></i>This demonstrates the essential (but not quite complete) elements of implementing a DApp with Reach.\n  There's no magic involved, but it definitely feels like there is when you're building a Reach application.\n  As a developer, you don't need to think about forming transaction groups, SDK calls, \"opting in\", or \"ASA ids\".\n  Because you don't think about these things, your application works on multiple\n  networks.\n  You focus on the business logic of your DApp and plug into the consensus network of your choice.<a href=\"#p_14\" class=\"pid\">14</a>\n</p>","<ul><li class=\"dynamic\"><a href=\"#guide-staking\">Example: Staking and Unstaking Tokens</a></li>\n  <li class=\"dynamic\"><a href=\"#staking\">Staking</a></li>\n  <li class=\"dynamic\"><a href=\"#unstaking\">Unstaking</a></li>\n  <li class=\"dynamic\"><a href=\"#elided-reach\">Elided Reach</a></li>\n  <li class=\"dynamic\"><a href=\"#connecting-from-javascript\">Connecting from JavaScript</a></li>\n  <li class=\"dynamic\"><a href=\"#conclusion\">Conclusion</a></li></ul>"]